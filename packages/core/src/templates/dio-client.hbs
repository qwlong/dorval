import 'package:dio/dio.dart';
{{#if hasInterceptors}}
import 'package:dio/io.dart';
{{/if}}

/// Base API client using Dio
/// 
/// This client handles all HTTP requests to the {{apiTitle}} API.
/// Base URL: {{baseUrl}}
class ApiClient {
  late final Dio dio;
  final String baseUrl;
  {{#if hasAuth}}
  String? _authToken;
  {{/if}}
  
  ApiClient({
    String? baseUrl,
    Dio? dioClient,
    {{#if hasInterceptors}}
    List<Interceptor>? interceptors,
    {{/if}}
    {{#if hasAuth}}
    String? authToken,
    {{/if}}
  }) : baseUrl = baseUrl ?? '{{defaultBaseUrl}}' {
    dio = dioClient ?? Dio();
    dio.options.baseUrl = this.baseUrl;
    
    // Set default headers
    dio.options.headers = {
      'Content-Type': 'application/json',
      'Accept': 'application/json',
      {{#each defaultHeaders}}
      '{{@key}}': '{{this}}',
      {{/each}}
    };
    
    // Set default timeout
    dio.options.connectTimeout = const Duration(seconds: {{connectTimeout}});
    dio.options.receiveTimeout = const Duration(seconds: {{receiveTimeout}});
    
    {{#if hasAuth}}
    // Set auth token if provided
    if (authToken != null) {
      setAuthToken(authToken);
    }
    {{/if}}
    
    {{#if hasInterceptors}}
    // Add custom interceptors
    if (interceptors != null) {
      dio.interceptors.addAll(interceptors);
    }
    {{/if}}
    
    // Add logging interceptor in debug mode
    if ({{enableLogging}}) {
      dio.interceptors.add(LogInterceptor(
        request: true,
        requestHeader: true,
        requestBody: true,
        responseHeader: true,
        responseBody: true,
        error: true,
        logPrint: (obj) => print(obj),
      ));
    }
    
    {{#if hasErrorInterceptor}}
    // Add error handling interceptor
    dio.interceptors.add(
      InterceptorsWrapper(
        onError: (DioException error, handler) {
          // Handle common errors
          if (error.response != null) {
            switch (error.response?.statusCode) {
              case 401:
                // Handle unauthorized
                _handleUnauthorized();
                break;
              case 403:
                // Handle forbidden
                _handleForbidden();
                break;
              case 404:
                // Handle not found
                break;
              case 500:
              case 502:
              case 503:
                // Handle server errors
                _handleServerError(error);
                break;
            }
          }
          handler.next(error);
        },
      ),
    );
    {{/if}}
  }
  
  {{#if hasAuth}}
  /// Set authentication token
  void setAuthToken(String token) {
    _authToken = token;
    dio.options.headers['Authorization'] = 'Bearer $token';
  }
  
  /// Clear authentication token
  void clearAuthToken() {
    _authToken = null;
    dio.options.headers.remove('Authorization');
  }
  
  /// Get current auth token
  String? get authToken => _authToken;
  {{/if}}
  
  {{#if hasErrorInterceptor}}
  void _handleUnauthorized() {
    // Clear auth token and redirect to login
    clearAuthToken();
    // You can emit an event or call a callback here
  }
  
  void _handleForbidden() {
    // Handle forbidden access
  }
  
  void _handleServerError(DioException error) {
    // Log server error or show notification
  }
  {{/if}}
  
  /// Create a new instance with custom configuration
  ApiClient copyWith({
    String? baseUrl,
    Dio? dioClient,
    {{#if hasAuth}}
    String? authToken,
    {{/if}}
  }) {
    return ApiClient(
      baseUrl: baseUrl ?? this.baseUrl,
      dioClient: dioClient ?? dio,
      {{#if hasAuth}}
      authToken: authToken ?? _authToken,
      {{/if}}
    );
  }
  
  /// Dispose of the client
  void dispose() {
    dio.close();
  }
  
  // HTTP method wrappers
  
  /// Perform GET request
  Future<Response<T>> get<T>(
    String path, {
    Map<String, dynamic>? queryParameters,
    Options? options,
    CancelToken? cancelToken,
    void Function(int, int)? onReceiveProgress,
  }) {
    return dio.get<T>(
      path,
      queryParameters: queryParameters,
      options: options,
      cancelToken: cancelToken,
      onReceiveProgress: onReceiveProgress,
    );
  }
  
  /// Perform POST request
  Future<Response<T>> post<T>(
    String path, {
    dynamic data,
    Map<String, dynamic>? queryParameters,
    Options? options,
    CancelToken? cancelToken,
    void Function(int, int)? onSendProgress,
    void Function(int, int)? onReceiveProgress,
  }) {
    return dio.post<T>(
      path,
      data: data,
      queryParameters: queryParameters,
      options: options,
      cancelToken: cancelToken,
      onSendProgress: onSendProgress,
      onReceiveProgress: onReceiveProgress,
    );
  }
  
  /// Perform PUT request
  Future<Response<T>> put<T>(
    String path, {
    dynamic data,
    Map<String, dynamic>? queryParameters,
    Options? options,
    CancelToken? cancelToken,
    void Function(int, int)? onSendProgress,
    void Function(int, int)? onReceiveProgress,
  }) {
    return dio.put<T>(
      path,
      data: data,
      queryParameters: queryParameters,
      options: options,
      cancelToken: cancelToken,
      onSendProgress: onSendProgress,
      onReceiveProgress: onReceiveProgress,
    );
  }
  
  /// Perform PATCH request
  Future<Response<T>> patch<T>(
    String path, {
    dynamic data,
    Map<String, dynamic>? queryParameters,
    Options? options,
    CancelToken? cancelToken,
    void Function(int, int)? onSendProgress,
    void Function(int, int)? onReceiveProgress,
  }) {
    return dio.patch<T>(
      path,
      data: data,
      queryParameters: queryParameters,
      options: options,
      cancelToken: cancelToken,
      onSendProgress: onSendProgress,
      onReceiveProgress: onReceiveProgress,
    );
  }
  
  /// Perform DELETE request
  Future<Response<T>> delete<T>(
    String path, {
    dynamic data,
    Map<String, dynamic>? queryParameters,
    Options? options,
    CancelToken? cancelToken,
  }) {
    return dio.delete<T>(
      path,
      data: data,
      queryParameters: queryParameters,
      options: options,
      cancelToken: cancelToken,
    );
  }
  
  /// Perform HEAD request
  Future<Response<T>> head<T>(
    String path, {
    dynamic data,
    Map<String, dynamic>? queryParameters,
    Options? options,
    CancelToken? cancelToken,
  }) {
    return dio.head<T>(
      path,
      data: data,
      queryParameters: queryParameters,
      options: options,
      cancelToken: cancelToken,
    );
  }
}